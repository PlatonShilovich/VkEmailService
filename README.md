```markdown
# üöÄ VkEmailService - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è email-—Å–µ—Ä–≤–∏—Å–∞ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ

–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è email-–∫–∞–º–ø–∞–Ω–∏—è–º–∏.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 5 –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:

- **üåê API Gateway** ‚Äî –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- **üë• User Segmentation Service** ‚Äî –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º  
- **üß™ A/B Testing Service** ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **üìß Email Campaign Service** ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ email-–∫–∞–º–ø–∞–Ω–∏—è–º–∏
- **üìä Analytics Service** ‚Äî –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **.NET 8** ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
- **PostgreSQL** ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Redis** ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Apache Kafka** ‚Äî –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- **Docker** ‚Äî –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Entity Framework Core** ‚Äî ORM
- **MediatR** ‚Äî CQRS –ø–∞—Ç—Ç–µ—Ä–Ω
- **AutoMapper** ‚Äî –ú–∞–ø–ø–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–æ–≤
- **Serilog** ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

```


# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

dotnet --version  \# >= 8.0
docker --version
docker-compose --version

```

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```

git clone https://github.com/your-username/VkEmailService.git
cd VkEmailService

```

### 2. –ó–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã

```


# –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

./startup-fixed.sh:
```
#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ VkEmailService - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è email-—Å–µ—Ä–≤–∏—Å–∞ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ"
echo "======================================================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
check_service_health() {
local service_name=$1
local url=$2
local max_attempts=30
local attempt=1

    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ $service_name..."
    while [ $attempt -le $max_attempts ]; do
        if curl -s -f "$url" > /dev/null 2>&1; then
            echo "‚úÖ $service_name –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            return 0
        fi
        echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts –¥–ª—è $service_name..."
        sleep 2
        attempt=$((attempt + 1))
    done
    echo "‚ùå $service_name –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
    return 1
}

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down -v

# –û—á–∏—â–∞–µ–º Docker
echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker —Å–∏—Å—Ç–µ–º—ã..."
docker system prune -f

# –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—ç—Ç–∞–ø–Ω–æ
echo "üîß –ó–∞–ø—É—Å–∫ PostgreSQL –∏ Redis..."
docker compose up -d postgres redis

# –ñ–¥–µ–º PostgreSQL –∏ Redis
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ PostgreSQL –∏ Redis (15 —Å–µ–∫)..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL..."
docker compose exec postgres pg_isready -U admin -d vkemail

# –ó–∞–ø—É—Å–∫–∞–µ–º ZooKeeper
echo "üêò –ó–∞–ø—É—Å–∫ ZooKeeper..."
docker compose up -d zookeeper

# –ñ–¥–µ–º ZooKeeper (—É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è)
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ZooKeeper (60 —Å–µ–∫)..."
sleep 60

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å ZooKeeper
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ZooKeeper..."
docker compose ps zookeeper

# –ó–∞–ø—É—Å–∫–∞–µ–º Kafka
echo "üì® –ó–∞–ø—É—Å–∫ Kafka..."
docker compose up -d kafka

# –ñ–¥–µ–º Kafka
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Kafka (45 —Å–µ–∫)..."
sleep 45

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
echo "üîç –°—Ç–∞—Ç—É—Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:"
docker compose ps postgres redis zookeeper kafka

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
echo "üèóÔ∏è –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose up -d --build

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫)..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoints
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."

check_service_health "API Gateway" "http://localhost:5113/health"
check_service_health "User Segmentation" "http://localhost:5285/health"  
check_service_health "A/B Testing" "http://localhost:5071/health"
check_service_health "Email Campaign" "http://localhost:5218/health"
check_service_health "Analytics" "http://localhost:5133/health"

echo ""
echo "üéâ –í–°–ï –°–ï–†–í–ò–°–´ –ó–ê–ü–£–©–ï–ù–´ –£–°–ü–ï–®–ù–û!"
echo "======================================================================"
echo "üåê –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ –°–µ—Ä–≤–∏—Å                  ‚îÇ URL                                      ‚îÇ"
echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄÔøΩ"
echo "‚îÇ API Gateway             ‚îÇ http://localhost:5113/swagger            ‚îÇ"
echo "‚îÇ User Segmentation       ‚îÇ http://localhost:5285/swagger            ‚îÇ"
echo "‚îÇ A/B Testing             ‚îÇ http://localhost:5071/swagger            ‚îÇ"
echo "‚îÇ Email Campaign          ‚îÇ http://localhost:5218/swagger            ‚îÇ"
echo "‚îÇ Analytics               ‚îÇ http://localhost:5133/swagger            ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
echo ""
echo "üîó –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:"
echo "‚Ä¢ User Segmentation API: http://localhost:5285/swagger"
echo "‚Ä¢ A/B Testing API:       http://localhost:5071/swagger"  
echo "‚Ä¢ Email Campaign API:    http://localhost:5218/swagger"
echo "‚Ä¢ Analytics API:         http://localhost:5133/swagger"
echo "‚Ä¢ API Gateway:           http://localhost:5113/swagger"
echo ""
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
echo "‚Ä¢ –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:  docker compose ps"
echo "‚Ä¢ –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞:          docker compose logs -f [service-name]"
echo "‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞:             docker compose down"
echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"
```

```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
- http://localhost:5113/swagger ‚Äî API Gateway
- http://localhost:5285/swagger ‚Äî User Segmentation  
- http://localhost:5071/swagger ‚Äî A/B Testing
- http://localhost:5218/swagger ‚Äî Email Campaign
- http://localhost:5133/swagger ‚Äî Analytics

## üìñ API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã

### üåê API Gateway (–ø–æ—Ä—Ç 5113)

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Gateway –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É: `/api/{service}/{endpoint}`

#### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ Gateway:

```


# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ Gateway

curl http://localhost:5113/api/usersegmentation/segments

# –°–æ–∑–¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —á–µ—Ä–µ–∑ Gateway

curl -X POST http://localhost:5113/api/abtesting/experiments \
-H "Content-Type: application/json" \
-d '{
"name": "Email Subject Test",
"description": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–∏—Å–µ–º",
"trafficSplit": "50/50"
}'

```

### üë• User Segmentation Service (–ø–æ—Ä—Ç 5285)

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```

curl -X POST http://localhost:5285/api/segments \
-H "Content-Type: application/json" \
-d '{
"name": "–ú–æ–ª–æ–¥—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ú–æ—Å–∫–≤—ã",
"description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ 18-25 –ª–µ—Ç –∏–∑ –ú–æ—Å–∫–≤—ã",
"criteria": "{\"ageRange\":{\"min\":18,\"max\":25},\"locations\":[\"–ú–æ—Å–∫–≤–∞\"]}"
}'

```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```

{
"id": "123e4567-e89b-12d3-a456-426614174000",
"name": "–ú–æ–ª–æ–¥—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ú–æ—Å–∫–≤—ã",
"description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ 18-25 –ª–µ—Ç –∏–∑ –ú–æ—Å–∫–≤—ã",
"criteria": "{\"ageRange\":{\"min\":18,\"max\":25},\"locations\":[\"–ú–æ—Å–∫–≤–∞\"]}",
"createdAt": "2025-01-15T10:30:00Z",
"updatedAt": "2025-01-15T10:30:00Z"
}

```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–º–µ–Ω—Ç–∞

```

curl -X POST http://localhost:5285/api/segments/123e4567-e89b-12d3-a456-426614174000/users \
-H "Content-Type: application/json" \
-d '{
"ageRange": {"min": 18, "max": 25},
"locations": ["–ú–æ—Å–∫–≤–∞"]
}'

```

### üß™ A/B Testing Service (–ø–æ—Ä—Ç 5071)

#### –°–æ–∑–¥–∞–Ω–∏–µ A/B —Ç–µ—Å—Ç–∞

```

curl -X POST http://localhost:5071/api/experiments \
-H "Content-Type: application/json" \
-d '{
"name": "–¢–µ—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–∏—Å–µ–º",
"description": "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤",
"trafficSplit": "50/50",
"variants": [
{
"name": "–í–∞—Ä–∏–∞–Ω—Ç A",
"weight": 0.5,
"content": "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞—Å!"
},
{
"name": "–í–∞—Ä–∏–∞–Ω—Ç B",
"weight": 0.5,
"content": "–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∏–¥–∫—É 50%!"
}
]
}'

```

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç

```

curl -X POST http://localhost:5071/api/experiments/123e4567-e89b-12d3-a456-426614174000/assign-user \
-H "Content-Type: application/json" \
-d '"user-id-here"'

```

### üìß Email Campaign Service (–ø–æ—Ä—Ç 5218)

#### –°–æ–∑–¥–∞–Ω–∏–µ email –∫–∞–º–ø–∞–Ω–∏–∏

```

curl -X POST http://localhost:5218/api/campaigns \
-H "Content-Type: application/json" \
-d '{
"name": "–í–µ—Å–µ–Ω–Ω—è—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞",
"subject": "{{\#if experiment}}{{experiment.subject}}{{else}}–í–µ—Å–µ–Ω–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –¥–æ 70%!{{/if}}",
"content": "<h1>–ü—Ä–∏–≤–µ—Ç, {{user.name}}!</h1><p>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å —Å–∫–∏–¥–∫–∞ {{discount}}%</p>",
"segmentId": "123e4567-e89b-12d3-a456-426614174000",
"experimentId": "456e7890-e89b-12d3-a456-426614174000",
"status": "Draft"
}'

```

### üìä Analytics Service (–ø–æ—Ä—Ç 5133)

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

```

curl -X POST http://localhost:5133/api/events \
-H "Content-Type: application/json" \
-d '{
"userId": "user-123",
"campaignId": "campaign-456",
"eventType": "email_open",
"metadata": "{\"device\":\"mobile\",\"location\":\"Moscow\"}"
}'

```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∫–∞–º–ø–∞–Ω–∏–∏

```

curl http://localhost:5133/api/events/metrics/campaign-456

```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```

{
"ctr": 0.15,
"cr": 0.08,
"bounceRate": 0.02
}

```

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

```


# User Segmentation Service

cd src/Services/UserSegmentation
dotnet run

# A/B Testing Service

cd src/Services/ABTesting
dotnet run

# –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```


# UserSegmentation

cd src/Services/UserSegmentation
dotnet ef migrations add Initial --context UserSegmentationDbContext
dotnet ef database update --connection "Host=localhost;Port=5432;Database=vkemail;Username=admin;Password=password"

# ABTesting

cd src/Services/ABTesting
dotnet ef migrations add Initial --context ABTestingDbContext
dotnet ef database update --connection "Host=localhost;Port=5432;Database=vkemail;Username=admin;Password=password"

# EmailCampaign

cd src/Services/EmailCampaign
dotnet ef migrations add Initial --context EmailCampaignDbContext
dotnet ef database update --connection "Host=localhost;Port=5432;Database=vkemail;Username=admin;Password=password"

# Analytics

cd src/Services/Analytics
dotnet ef migrations add Initial --context AnalyticsDbContext
dotnet ef database update --connection "Host=localhost;Port=5432;Database=vkemail;Username=admin;Password=password"

```

## üê≥ Docker –∫–æ–º–∞–Ω–¥—ã

```


# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

docker compose up -d

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

docker compose up -d postgres redis zookeeper kafka

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

docker compose logs -f usersegmentation
docker compose logs -f abtesting

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞

docker compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

docker compose down -v
docker system prune -f

```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### Health Checks

```

curl http://localhost:5113/health  \# API Gateway
curl http://localhost:5285/health  \# User Segmentation
curl http://localhost:5071/health  \# A/B Testing
curl http://localhost:5218/health  \# Email Campaign
curl http://localhost:5133/health  \# Analytics

```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```


# PostgreSQL

docker exec -it \$(docker compose ps -q postgres) psql -U admin -d vkemail

# –°–ø–∏—Å–æ–∫ —Å—Ö–µ–º

\dn

# –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –≤ —Å—Ö–µ–º–µ

\dt usersegmentation.*
\dt abtesting.*
\dt emailcampaign.*
\dt analytics.*

```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis

```


# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis

docker exec -it \$(docker compose ps -q redis) redis-cli

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–ª—é—á–µ–π

KEYS *

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è

GET "segment:123:criteria:..."

```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```


# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

dotnet test

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

cd tests/UserSegmentation.Tests
dotnet test

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å Testcontainers

cd tests/Integration.Tests
dotnet test

```

## üìä –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞

```


# –°–æ–∑–¥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"

SEGMENT_ID=\$(curl -s -X POST http://localhost:5285/api/segments \
-H "Content-Type: application/json" \
-d '{
"name": "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
"description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π",
"criteria": "{\"activityPeriod\":{\"from\":\"2025-01-08T00:00:00Z\",\"to\":\"2025-01-15T23:59:59Z\"}}"
}' | jq -r '.id')

echo "–°–æ–∑–¥–∞–Ω —Å–µ–≥–º–µ–Ω—Ç: \$SEGMENT_ID"

```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ A/B —Ç–µ—Å—Ç–∞

```


# –°–æ–∑–¥–∞–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

EXPERIMENT_ID=\$(curl -s -X POST http://localhost:5071/api/experiments \
-H "Content-Type: application/json" \
-d '{
"name": "–¢–µ—Å—Ç email –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤",
"description": "A/B —Ç–µ—Å—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º–æ—Å—Ç–∏ –ø–∏—Å–µ–º",
"trafficSplit": "50/50",
"variants": [
{"name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π", "weight": 0.5, "content": "–ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ"},
{"name": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π", "weight": 0.5, "content": "üî• –ì–æ—Ä—è—á–∏–µ –Ω–æ–≤–∏–Ω–∫–∏ —É–∂–µ –∑–¥–µ—Å—å!"}
]
}' | jq -r '.id')

echo "–°–æ–∑–¥–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: \$EXPERIMENT_ID"

```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ email –∫–∞–º–ø–∞–Ω–∏–∏

```


# –°–æ–∑–¥–∞–µ–º –∫–∞–º–ø–∞–Ω–∏—é, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å —Å–µ–≥–º–µ–Ω—Ç–æ–º –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–º

CAMPAIGN_ID=$(curl -s -X POST http://localhost:5218/api/campaigns \
-H "Content-Type: application/json" \
-d "{
\"name\": \"–†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤\",
\"subject\": \"{{variant.content}}\",
\"content\": \"<h1>–ü—Ä–∏–≤–µ—Ç!</h1><p>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞—à–∏ –Ω–æ–≤–∏–Ω–∫–∏</p>\",
\"segmentId\": \"$SEGMENT_ID\",
\"experimentId\": \"\$EXPERIMENT_ID\",
\"status\": \"Ready\"
}" | jq -r '.id')

echo "–°–æ–∑–¥–∞–Ω–∞ –∫–∞–º–ø–∞–Ω–∏—è: \$CAMPAIGN_ID"

```

### 4. –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞

```


# –ó–∞–ø—É—Å–∫–∞–µ–º A/B —Ç–µ—Å—Ç

curl -X PUT "http://localhost:5071/api/experiments/\$EXPERIMENT_ID/start"
echo "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω"

```

### 5. –°–∏–º—É–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏–π

```


# –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∏—Å—å–º–∞

curl -X POST http://localhost:5133/api/events \
-H "Content-Type: application/json" \
-d "{
\"userId\": \"user-001\",
\"campaignId\": \"\$CAMPAIGN_ID\",
\"eventType\": \"email_open\",
\"metadata\": \"{\\\"variant\\\":\\\"A\\\"}\"
}"

curl -X POST http://localhost:5133/api/events \
-H "Content-Type: application/json" \
-d "{
\"userId\": \"user-002\",
\"campaignId\": \"\$CAMPAIGN_ID\",
\"eventType\": \"email_click\",
\"metadata\": \"{\\\"variant\\\":\\\"B\\\"}\"
}"

```

### 6. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```


# –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞

curl "http://localhost:5071/api/experiments/\$EXPERIMENT_ID/results"

# –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–º–ø–∞–Ω–∏–∏

curl "http://localhost:5133/api/events/metrics/\$CAMPAIGN_ID"

```

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|----------------------|
| `ConnectionStrings__Postgres` | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | `Host=postgres;Port=5432;Database=vkemail;Username=admin;Password=password` |
| `ConnectionStrings__Redis` | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis | `redis:6379` |
| `Kafka__BootstrapServers` | –ê–¥—Ä–µ—Å Kafka –±—Ä–æ–∫–µ—Ä–æ–≤ | `kafka:9092` |
| `ASPNETCORE_ENVIRONMENT` | –û–∫—Ä—É–∂–µ–Ω–∏–µ .NET | `Development` |

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```


# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

docker compose logs -f [service-name]

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–Ω—è—Ç—ã–µ –ø–æ—Ä—Ç—ã

netstat -tlnp | grep :5432

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker

sudo systemctl restart docker

```

### –ü—Ä–æ–±–ª–µ–º–∞: ZooKeeper –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç healthcheck

```


# –£–≤–µ–ª–∏—á—å—Ç–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ startup-fixed.sh

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ZooKeeper

docker compose logs zookeeper

```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π

```


# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

dotnet ef migrations remove
dotnet ef migrations add Initial
dotnet ef database update

```

## üöÄ –î–µ–ø–ª–æ–π

### Production –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –≤ `docker-compose.yaml`
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
3. –ò–∑–º–µ–Ω–∏—Ç–µ `ASPNETCORE_ENVIRONMENT` –Ω–∞ `Production`
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ external volumes –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. —Ñ–∞–π–ª [LICENSE](LICENSE)

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

1. Fork –ø—Ä–æ–µ–∫—Ç–∞
2. –°–æ–∑–¥–∞–π—Ç–µ feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit –∏–∑–º–µ–Ω–µ–Ω–∏—è (`git commit -m 'Add AmazingFeature'`)
4. Push –≤ branch (`git push origin feature/AmazingFeature`)
5. –û—Ç–∫—Ä–æ–π—Ç–µ Pull Request

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫**: –í–∞—à–µ –∏–º—è
- **Email**: your.email@example.com  
- **Telegram**: @yourusername

---

‚≠ê **–ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥–æ—á–∫—É!**
```
